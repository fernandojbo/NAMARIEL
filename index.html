<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NAMARIEL - Contagem Inteligente</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      margin: 0;
      padding: 15px;
      text-align: center;
    }
    h1 {
      color: #2b6cb0;
    }
    button {
      padding: 10px 20px;
      margin: 8px;
      border: none;
      border-radius: 6px;
      background-color: #2b6cb0;
      color: white;
      font-size: 16px;
    }
    button:disabled {
      background-color: #aaa;
    }
    video, img, canvas {
      width: 100%;
      max-width: 350px;
      border-radius: 10px;
      margin-top: 10px;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
    }
    .info {
      margin-top: 10px;
      text-align: left;
      max-width: 350px;
      display: inline-block;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
  </style>

  <!-- TensorFlow + modelo COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
</head>
<body>
  <h1>NAMARIEL ğŸ“¦</h1>
  <p>Contagem inteligente de volumes</p>

  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="photoPreview" style="display:none;" />
  <canvas id="overlay"></canvas>

  <div>
    <button id="startCamera">ğŸ“· Abrir CÃ¢mera</button>
    <button id="takePhoto" disabled>ğŸ“¸ Tirar Foto</button>
    <button id="deletePhoto" disabled>ğŸ—‘ï¸ Apagar Foto</button>
    <button id="detectBtn" disabled>ğŸ” Detectar Volumes</button>
  </div>

  <div class="info">
    <label>ğŸ“¦ Quantidade detectada:</label>
    <input type="number" id="quantity" readonly style="width:70px; text-align:center;" />
    <br><br>
    <label>Limiar de confianÃ§a: <span id="thVal">50%</span></label>
    <input id="threshold" type="range" min="0" max="100" value="50">
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const photoPreview = document.getElementById('photoPreview');
    const overlay = document.getElementById('overlay');
    const startCamera = document.getElementById('startCamera');
    const takePhoto = document.getElementById('takePhoto');
    const deletePhoto = document.getElementById('deletePhoto');
    const detectBtn = document.getElementById('detectBtn');
    const thresholdInput = document.getElementById('threshold');
    const thVal = document.getElementById('thVal');
    const quantity = document.getElementById('quantity');

    let model = null;
    let stream = null;

    thresholdInput.addEventListener('input', () => {
      thVal.textContent = thresholdInput.value + '%';
    });

    async function startCam() {
      try {
        // ğŸ”§ forÃ§a o uso da cÃ¢mera traseira
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } },
          audio: false
        });
        video.srcObject = stream;
        takePhoto.disabled = false;
        deletePhoto.disabled = true;
      } catch (err) {
        alert('Erro ao acessar cÃ¢mera traseira. Tente permitir o uso da cÃ¢mera nas configuraÃ§Ãµes do navegador.');
        console.error(err);
      }
    }

    startCamera.addEventListener('click', startCam);

    takePhoto.addEventListener('click', () => {
      if (!video.srcObject) return alert("Abra a cÃ¢mera primeiro!");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const dataURL = canvas.toDataURL('image/png');
      photoPreview.src = dataURL;
      photoPreview.style.display = 'block';
      overlay.width = video.videoWidth;
      overlay.height = video.videoHeight;
      detectBtn.disabled = false;
      deletePhoto.disabled = false;
      video.style.display = 'none';
    });

    deletePhoto.addEventListener('click', () => {
      photoPreview.style.display = 'none';
      overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);
      video.style.display = 'block';
      detectBtn.disabled = true;
      deletePhoto.disabled = true;
    });

    async function loadModel() {
      detectBtn.disabled = true;
      detectBtn.textContent = 'â³ Carregando modelo...';
      model = await cocoSsd.load();
      detectBtn.textContent = 'ğŸ” Detectar Volumes';
      detectBtn.disabled = false;
    }

    function drawBoxes(predictions) {
      const ctxOverlay = overlay.getContext('2d');
      ctxOverlay.clearRect(0, 0, overlay.width, overlay.height);
      ctxOverlay.lineWidth = 2;
      ctxOverlay.font = '14px sans-serif';
      predictions.forEach(p => {
        ctxOverlay.strokeStyle = 'lime';
        ctxOverlay.fillStyle = 'rgba(0,255,0,0.3)';
        const [x, y, w, h] = p.bbox;
        ctxOverlay.strokeRect(x, y, w, h);
        ctxOverlay.fillRect(x, y, w, h);
        ctxOverlay.fillStyle = 'black';
        ctxOverlay.fillText(`${p.class} ${(p.score*100).toFixed(0)}%`, x+5, y+15);
      });
    }

    async function runDetection() {
      if (!photoPreview.src) {
        alert('Tire uma foto primeiro!');
        return;
      }
      const threshold = Number(thresholdInput.value) / 100;
      const predictions = await model.detect(photoPreview);
      const filtered = predictions.filter(p => p.score >= threshold && (p.bbox[2]*p.bbox[3]) > 3000);
      drawBoxes(filtered);
      quantity.value = filtered.length;
    }

    detectBtn.addEventListener('click', async () => {
      if (!model) await loadModel();
      detectBtn.textContent = 'Detectando...';
      detectBtn.disabled = true;
      await runDetection();
      detectBtn.textContent = 'ğŸ” Detectar Volumes';
      detectBtn.disabled = false;
    });

    loadModel();
  </script>
</body>
</html>
